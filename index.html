<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ladetarif-Rechner</title>

  <!-- App Icon (icon.png im Repo-Root) -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon.PNG?v=4">
  <link rel="icon" type="image/png" sizes="32x32" href="icon.PNG?v=4">
  <link rel="icon" type="image/png" sizes="16x16" href="icon.PNG?v=4">

  <style>
    :root { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif; }
    body { margin: 16px; background:#f7f7f8; color:#111; }
    .wrap { max-width: 980px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 6px 0 14px; }
    h2 { font-size: 16px; margin: 18px 0 10px; }

    .card { background:#fff; border:1px solid #e6e6e9; border-radius: 12px; padding: 14px; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .grid { display:grid; gap: 10px; }
    .g3 { grid-template-columns: repeat(3, minmax(0,1fr)); }
    @media (max-width: 760px){ .g3{ grid-template-columns: 1fr; } }

    label { display:block; font-size: 12px; color:#444; margin-bottom: 4px; }

    input, select {
      width: 100%;
      padding: 10px 10px;
      border:1px solid #d7d7dc;
      border-radius: 10px;
      font-size: 14px;
      background:#fff;
      box-sizing: border-box;
    }

    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    button { padding: 10px 12px; border:1px solid #d7d7dc; border-radius: 10px; background:#fff; cursor:pointer; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    .muted { color:#666; font-size: 12px; }
    .result { display:grid; gap: 6px; margin-top: 10px; padding: 10px; border-radius: 10px; background:#f3f4f6; }
    .big { font-size: 18px; font-weight: 700; }
    .small { font-size: 12px; color:#444; }
    .pill { display:inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; border:1px solid #ddd; background:#fff; }
    .hide { display:none; }

    /* ===== Tabelle / Mobile ===== */
    .tableWrap{
      margin-top:12px;
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      border:1px solid #e6e6e9;
      background:#fff;
    }

    table{
      width:100%;
      border-collapse: collapse;
      /* weniger breit als vorher, aber iPhone quetscht nicht */
      min-width: 860px;
    }

    th,td{
      padding: 10px;
      border-bottom:1px solid #eee;
      text-align:left;
      font-size: 13px;
      vertical-align: top;
      background:#fff;
    }
    th{ background:#fafafa; font-weight: 600; }
    tr:last-child td{ border-bottom:none; }
    .num{ text-align:right; font-variant-numeric: tabular-nums; }
    .good{ background:#e9fbe9; }
    .bad{ background:#ffecec; }

    /* Name-Spalte */
    th.colName, td.colName{ width: 300px; min-width: 300px; }

    .namecell{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
    }
    .logo{ width:20px; height:20px; object-fit:contain; border-radius:6px; flex:0 0 auto; }

    /* Mitte zwischen vorher und jetzt: Name gut, Zahlen kompakt */
    .tariff-name{
      flex:1;
      width:100%;
      min-width: 180px;   /* kleiner als vorher (240/260), größer als ganz früher */
    }

    /* Inputs in Tabelle: kompakter */
    td input{
      padding: 8px 9px;   /* kleiner als Default */
      font-size: 13px;
      border-radius: 9px;
    }

    /* Zahlenspalten Inputs etwas schmaler */
    .cell-num{
      width: 96px;        /* “Mitte”: nicht riesig, nicht zu klein */
      max-width: 96px;
    }

    @media (max-width: 430px){
      body{ margin: 12px; }
      td input{ padding: 7px 8px; font-size: 13px; }
      th.colName, td.colName{ min-width: 320px; } /* Name bleibt gut tippbar */
      .tariff-name{ min-width: 200px; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <h1>Ladetarif-Rechner</h1>

  <!-- 1) Tarifübersicht -->
  <div class="card">
    <h2>1) Tarifübersicht: Ab welcher Fahrt lohnt sich ein Ladetarif?</h2>

    <div class="grid g3">
      <div>
        <label>Ladekosten ohne Tarif</label>
        <select id="basePricePreset">
          <option value="0.48">Yellow (EnBW) (0,48 €)</option>
          <option value="0.55">ADAC – Aral pulse (0,55 €)</option>
          <option value="0.56">EnBW (0,56 €)</option>
          <option value="custom">Sonstiges (eigener Preis)</option>
        </select>
        <div id="basePriceCustomWrap" class="hide" style="margin-top:8px;">
          <label>Eigener Preis (€/kWh)</label>
          <input id="basePriceCustom" type="number" step="0.01" value="0.48">
        </div>
      </div>

      <div>
        <label>Akkugröße (kWh)</label>
        <input id="batteryKwh" type="number" step="1" value="85">
      </div>

      <div>
        <label>Verbrauch (kWh/100km)</label>
        <input id="baseCons" type="number" step="0.1" value="17">
      </div>

      <div>
        <label>Ladezustand Start (%)</label>
        <input id="socStart" type="number" step="1" value="100">
      </div>
      <div>
        <label>Ladezustand Ende (%)</label>
        <input id="socEnd" type="number" step="1" value="20">
      </div>
      <div>
        <label>Option: Vergleichsstrecke (km)</label>
        <input id="tripKm" type="number" step="1" value="800">
      </div>
    </div>

    <div class="result" id="derivedBox"></div>

    <div class="row" style="margin-top:10px;">
      <button class="primary" id="addRow">+ Tarif hinzufügen</button>
      <button id="reset">Standardtarife laden</button>
      <span class="muted">Tarife werden lokal im Browser gespeichert.</span>
    </div>

    <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="colName">Anbieter / Tarif</th>
            <th class="num">Grundgebühr<br><span class="small">(€/Monat)</span></th>
            <th class="num">Preis<br><span class="small">(€/kWh)</span></th>
            <th class="num">Preis pro Ladung 100%<br><span class="small">(Akku × €/kWh)</span></th>
            <th class="num">Ersparnis ggü. Basis<br><span class="small">(ct/kWh)</span></th>
            <th class="num">Break-even<br><span class="small">(km Fahrt gesamt)</span></th>
            <th class="num">Kosten für <span id="tripKmLabel">800</span> km<br><span class="small">(nachzuladen + Grundgebühr)</span></th>
            <th class="num"></th>
          </tr>
        </thead>
        <tbody id="tariffBody"></tbody>
      </table>
    </div>

    <div class="muted" style="margin-top:10px; line-height:1.5;">
      Logik:
      <span class="pill">Verfügbare Energie = Akku × (Start% − Ende%)</span>
      <span class="pill">Start-km = Verf. Energie / (Verbrauch/100)</span>
      <span class="pill">Break-even-kWh = Grundgebühr / (Basis − Tarif)</span>
      <span class="pill">Break-even-Fahrt-km = Start-km + (Break-even-kWh / (Verbrauch/100))</span>
    </div>
  </div>

  <!-- 2) Schnellrechner 1 -->
  <div class="card" style="margin-top:14px;">
    <h2>2) Schnellrechner: kWh → Preisdifferenz</h2>
    <div class="grid g3">
      <div>
        <label>Zu ladende Energie (kWh)</label>
        <input id="kwh1" type="number" step="1" value="50">
      </div>
      <div>
        <label>Preis A (€/kWh)</label>
        <input id="pA1" type="number" step="0.01" value="0.48">
      </div>
      <div>
        <label>Preis B (€/kWh)</label>
        <input id="pB1" type="number" step="0.01" value="0.39">
      </div>
    </div>
    <div class="result" id="out1"></div>
  </div>

  <!-- 3) Schnellrechner 2 -->
  <div class="card" style="margin-top:14px;">
    <h2>3) Schnellrechner: Strecke &amp; Verbrauch → Preisdifferenz</h2>
    <div class="grid g3">
      <div>
        <label>Strecke (km)</label>
        <input id="km2" type="number" step="1" value="800">
      </div>
      <div>
        <label>Verbrauch (kWh/100km)</label>
        <input id="cons2" type="number" step="0.1" value="17">
      </div>
      <div>
        <label>Preis A (€/kWh)</label>
        <input id="pA2" type="number" step="0.01" value="0.48">
      </div>
      <div>
        <label>Preis B (€/kWh)</label>
        <input id="pB2" type="number" step="0.01" value="0.39">
      </div>
      <div>
        <label>Geladene kWh (automatisch)</label>
        <input id="kwh2" type="number" step="0.1" value="0" disabled>
      </div>
    </div>
    <div class="result" id="out2"></div>
    <div class="muted">Hinweis: kWh = km × (Verbrauch/100)</div>
  </div>

</div>

<script>
  const fmtEUR = (v) => isFinite(v) ? v.toLocaleString('de-DE', {style:'currency', currency:'EUR'}) : '–';
  const fmtNum = (v, d=1) => isFinite(v) ? v.toLocaleString('de-DE', {minimumFractionDigits:d, maximumFractionDigits:d}) : '–';
  const clamp = (x, a, b) => Math.max(a, Math.min(b, x));

  // ---------- Logo-Icons (SVG Data URI, keine externen Links) ----------
  function svgDataUri(svg){
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }
  function logoForKey(key){
    const k = (key || "").toLowerCase();
    if(k === "tesla"){
      return svgDataUri(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="12" fill="#111"/><text x="32" y="40" font-size="28" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">T</text></svg>`);
    }
    if(k === "enbw"){
      return svgDataUri(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="12" fill="#1b1b1b"/><text x="32" y="40" font-size="18" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">EnBW</text></svg>`);
    }
    if(k === "mb"){
      return svgDataUri(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="12" fill="#0f172a"/><text x="32" y="40" font-size="20" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">MB</text></svg>`);
    }
    if(k === "ionity"){
      return svgDataUri(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="12" fill="#111827"/><text x="32" y="40" font-size="18" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">ION</text></svg>`);
    }
    if(k === "shell"){
      return svgDataUri(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="12" fill="#111"/><text x="32" y="40" font-size="18" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">Shell</text></svg>`);
    }
    return svgDataUri(`<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="64" height="64" rx="12" fill="#6b7280"/><text x="32" y="40" font-size="18" text-anchor="middle" fill="#fff" font-family="Arial" font-weight="700">EV</text></svg>`);
  }
  function getLogo(tariff){
    if(tariff && tariff.logoKey) return logoForKey(tariff.logoKey);
    const n = ((tariff && tariff.name) ? tariff.name : "").toLowerCase();
    if(n.includes("tesla")) return logoForKey("tesla");
    if(n.includes("enbw")) return logoForKey("enbw");
    if(n.includes("ionity")) return logoForKey("ionity");
    if(n.includes("shell")) return logoForKey("shell");
    if(n.includes("mb") || n.includes("mercedes")) return logoForKey("mb");
    return logoForKey("generic");
  }

  // ---------- Schnellrechner ----------
  function calc1(){
    const kwh = parseFloat(document.getElementById('kwh1').value) || 0;
    const pA  = parseFloat(document.getElementById('pA1').value) || 0;
    const pB  = parseFloat(document.getElementById('pB1').value) || 0;
    const costA = kwh * pA;
    const costB = kwh * pB;
    const diff  = costB - costA;

    document.getElementById('out1').innerHTML = `
      <div>Kosten A: <span class="big">${fmtEUR(costA)}</span></div>
      <div>Kosten B: <span class="big">${fmtEUR(costB)}</span></div>
      <div>Differenz (B − A): <span class="big">${fmtEUR(diff)}</span></div>
    `;
  }

  function calc2(){
    const km   = parseFloat(document.getElementById('km2').value) || 0;
    const cons = parseFloat(document.getElementById('cons2').value) || 0;
    const pA   = parseFloat(document.getElementById('pA2').value) || 0;
    const pB   = parseFloat(document.getElementById('pB2').value) || 0;

    const kwh = km * (cons/100);
    document.getElementById('kwh2').value = (isFinite(kwh) ? kwh.toFixed(1) : "0.0");

    const costA = kwh * pA;
    const costB = kwh * pB;
    const diff  = costB - costA;

    document.getElementById('out2').innerHTML = `
      <div>Geladene Energie: <span class="big">${fmtNum(kwh,1)} kWh</span></div>
      <div>Kosten A: <span class="big">${fmtEUR(costA)}</span></div>
      <div>Kosten B: <span class="big">${fmtEUR(costB)}</span></div>
      <div>Differenz (B − A): <span class="big">${fmtEUR(diff)}</span></div>
    `;
  }

  // ---------- Tarifübersicht ----------
  const LS_KEY = 'lade_tarife_v6';

  function defaultTariffs(){
    return [
      {name:'Tesla Charge Tarif',          monthly:11.99, price:0.45, logoKey:'tesla'},
      {name:'EnBW Ladetarif M',            monthly: 5.99, price:0.46, logoKey:'enbw'},
      {name:'EnBW Ladetarif L',            monthly:11.99, price:0.39, logoKey:'enbw'},
      {name:'MB Charge M (MB-Network)',    monthly: 4.90, price:0.39, logoKey:'mb'},
      {name:'MB Charge L (MB-Network)',    monthly: 9.90, price:0.39, logoKey:'mb'},
      {name:'MB Charge M (Ionity)',        monthly: 4.90, price:0.49, logoKey:'ionity'},
      {name:'MB Charge L (Ionity)',        monthly: 9.90, price:0.44, logoKey:'ionity'},
      {name:'Ionity (Mitarbeiter)',        monthly: 9.99, price:0.39, logoKey:'ionity'},
      {name:'Shell Recharge',              monthly: 5.99, price:0.44, logoKey:'shell'},
    ];
  }

  function saveTariffs(tariffs){
    try { localStorage.setItem(LS_KEY, JSON.stringify(tariffs)); } catch(e) {}
  }
  function loadTariffs(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return defaultTariffs();
      const parsed = JSON.parse(raw);
      if(!Array.isArray(parsed) || parsed.length === 0) return defaultTariffs();
      return parsed;
    } catch(e){
      return defaultTariffs();
    }
  }

  let tariffs = loadTariffs();

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));
  }

  function getBasePrice(){
    const preset = document.getElementById('basePricePreset').value;
    const customWrap = document.getElementById('basePriceCustomWrap');
    if(preset === 'custom'){
      customWrap.classList.remove('hide');
      return parseFloat(document.getElementById('basePriceCustom').value) || 0;
    } else {
      customWrap.classList.add('hide');
      return parseFloat(preset) || 0;
    }
  }

  function computeDerived(){
    const base = getBasePrice();

    let batt = parseFloat(document.getElementById('batteryKwh').value);
    if(!isFinite(batt)) batt = 0;
    batt = Math.max(0, Math.round(batt)); // nur ganze Zahlen

    const cons = parseFloat(document.getElementById('baseCons').value) || 0;

    let sStart = parseFloat(document.getElementById('socStart').value);
    let sEnd   = parseFloat(document.getElementById('socEnd').value);
    if(!isFinite(sStart)) sStart = 100;
    if(!isFinite(sEnd)) sEnd = 20;

    sStart = clamp(sStart, 0, 100);
    sEnd   = clamp(sEnd, 0, 100);

    const usablePct = Math.max(0, (sStart - sEnd) / 100);

    const availKwh = batt * usablePct;
    const availKm  = cons > 0 ? (availKwh / (cons/100)) : Infinity;

    const price100Base = batt * base;

    return { base, batt, cons, sStart, sEnd, availKwh, availKm, price100Base };
  }

  function renderTariffs(){
    const d = computeDerived();
    document.getElementById('batteryKwh').value = String(d.batt);

    const tripKm = parseFloat(document.getElementById('tripKm').value) || 0;
    document.getElementById('tripKmLabel').textContent = isFinite(tripKm) ? String(Math.round(tripKm)) : '–';

    const tripKwhTotal = tripKm * (d.cons/100);
    const needKwh = Math.max(0, tripKwhTotal - d.availKwh);

    document.getElementById('derivedBox').innerHTML = `
      <div>Verfügbare Energie (Start→Ende): <span class="big">${fmtNum(d.availKwh,1)} kWh</span></div>
      <div>Verfügbare Kilometer (Start→Ende): <span class="big">${isFinite(d.availKm) ? fmtNum(d.availKm,0) : '–'} km</span></div>
      <div>Preis Ladung 100% (ohne Tarif): <span class="big">${fmtEUR(d.price100Base)}</span></div>
      <div class="muted">Für Vergleichsstrecke: Gesamtbedarf ${fmtNum(tripKwhTotal,1)} kWh, davon nachzuladen ${fmtNum(needKwh,1)} kWh.</div>
    `;

    const tbody = document.getElementById('tariffBody');
    tbody.innerHTML = '';

    // ===== SORTIERUNG: lohnt sich zuerst, dann nach Streckenkosten =====
    const baseCost = needKwh * d.base;

    const sorted = tariffs
      .map((t, i) => ({ ...t, _idx: i }))
      .sort((a, b) => {
        const costA = needKwh * (Number(a.price)||0) + (Number(a.monthly)||0);
        const costB = needKwh * (Number(b.price)||0) + (Number(b.monthly)||0);

        const aBetter = costA < baseCost;
        const bBetter = costB < baseCost;

        if (aBetter !== bBetter) return aBetter ? -1 : 1; // „lohnt sich“ nach oben
        if (isFinite(costA) && isFinite(costB) && costA !== costB) return costA - costB; // günstigste Strecke zuerst
        return a._idx - b._idx; // stabil
      });

    // Render
    sorted.forEach((t) => {
      const monthly = Number(t.monthly) || 0;
      const price   = Number(t.price) || 0;

      const delta = d.base - price;

      let beTripKm = Infinity;
      if(delta > 0 && d.cons > 0){
        const beKwh = monthly / delta;
        const beKmCharged = beKwh / (d.cons/100);
        beTripKm = d.availKm + beKmCharged;
      }

      const price100 = d.batt * price;
      const deltaCt = delta * 100;

      const costBase = needKwh * d.base;
      const costTar  = needKwh * price + monthly;
      const better   = (isFinite(costTar) && isFinite(costBase)) ? (costTar < costBase) : false;

      const tr = document.createElement('tr');
      tr.className = better ? 'good' : 'bad';

      tr.innerHTML = `
        <td class="colName">
          <div class="namecell">
            <img class="logo" src="${getLogo(t)}" alt="">
            <input
              class="tariff-name"
              data-field="name"
              data-idx="${t._idx}"
              value="${escapeHtml(t.name ?? '')}"
            />
          </div>
        </td>
        <td class="num"><input class="cell-num" data-field="monthly" data-idx="${t._idx}" type="number" step="0.01" value="${monthly}" /></td>
        <td class="num"><input class="cell-num" data-field="price" data-idx="${t._idx}" type="number" step="0.01" value="${price}" /></td>
        <td class="num">${fmtEUR(price100)}</td>
        <td class="num">${isFinite(deltaCt) ? fmtNum(deltaCt,1) : '–'}</td>
        <td class="num">${(delta>0 && isFinite(beTripKm)) ? fmtNum(beTripKm,0) : '–'}</td>
        <td class="num">
          ${isFinite(costTar) ? fmtEUR(costTar) : '–'}
          <div class="small">Ohne Tarif: ${isFinite(costBase) ? fmtEUR(costBase) : '–'}</div>
        </td>
        <td class="num"><button data-del="${t._idx}">✕</button></td>
      `;
      tbody.appendChild(tr);
    });

    // Events
    tbody.querySelectorAll('input').forEach(inp => {
      inp.addEventListener('input', (e) => {
        const i = Number(e.target.dataset.idx);
        const f = e.target.dataset.field;

        if(f === 'name'){
          tariffs[i][f] = e.target.value;
        } else {
          tariffs[i][f] = Number(e.target.value);
        }

        saveTariffs(tariffs);
        renderTariffs();
      });
    });

    tbody.querySelectorAll('button[data-del]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const i = Number(e.target.dataset.del);
        tariffs.splice(i,1);
        saveTariffs(tariffs);
        renderTariffs();
      });
    });
  }

  // ---------- Wire up ----------
  ['kwh1','pA1','pB1'].forEach(id => document.getElementById(id).addEventListener('input', calc1));
  ['km2','cons2','pA2','pB2'].forEach(id => document.getElementById(id).addEventListener('input', calc2));

  ['basePricePreset','basePriceCustom','batteryKwh','baseCons','socStart','socEnd','tripKm']
    .forEach(id => document.getElementById(id).addEventListener('input', renderTariffs));

  document.getElementById('addRow').addEventListener('click', () => {
    tariffs.push({name:'Neuer Tarif', monthly:0, price:0, logoKey:''});
    saveTariffs(tariffs);
    renderTariffs();
  });

  document.getElementById('reset').addEventListener('click', () => {
    tariffs = defaultTariffs();
    saveTariffs(tariffs);
    renderTariffs();
  });

  // initial
  calc1(); calc2(); renderTariffs();
</script>
</body>
</html>
